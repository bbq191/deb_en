#+TITLE: Personal GNU Emacs Config
#+AUTHOR: Vinci Xu & Kate Ma
#+DESCRIPTION: Vinci & Kate's personal Emacs config
#+OPTIONS: toc:4

** Neecessory Configes
*** Global Keybinding
**** Basic

#+begin_src emacs-lisp
  (with-no-warnings
    ;; Key Modifiers
    (setq mac-option-modifier 'meta
      mac-command-modifier 'super)
    (bind-keys ([(super a)] . mark-whole-buffer)
           ([(super c)] . kill-ring-save)
           ([(super l)] . goto-line)
           ([(super q)] . save-buffers-kill-emacs)
           ([(super s)] . save-buffer)
           ([(super v)] . yank)
           ([(super w)] . delete-frame)
           ([(super z)] . undo)))
  ;; reload init

  ;; recent file
  (bind-keys ("C-x C-r" . recentf-open-files))
  ;; zooming in/out
  (global-set-key (kbd "C-=") 'text-scale-increase)
  (global-set-key (kbd "C--") 'text-scale-decrease)
    ;; Insert new line
  
#+end_src


** Shackle
Customize popwin behavior

#+begin_src emacs-lisp
  (use-package shackle
    :ensure t
    :hook (after-init . shackle-mode)
    :custom
    (shackle-default-size 0.5)
    (shackle-default-alignment 'below)
    (shackle-rules '((magit-status-mode    :select t :inhibit-window-quit t :same t)
                     (magit-log-mode       :select t :inhibit-window-quit t :same t)
                     (vc-annotate-mode     :select t :inhibit-window-quit t :same t)
                     ("*quickrun*"         :select t :inhibit-window-quit t :same t)
                     (profiler-report-mode :select t)
                     (xwidget-webkit-mode  :select t :same t)
                     (comint-mode          :select t :align t :size 0.4)
                     (grep-mode            :select t :align t)
                     (rg-mode              :select t :align t)
                     ;; See also `help-window-select'
                     (apropos-mode         :select nil :align t :size 0.4)
                     (help-mode            :select nil :align t :size 0.4)
                     ("*Flycheck errors*"         :select t   :align t :size 10)
                     ("*Backtrace*"               :select t   :align t :size 15)
                     ("*Shell Command Output*"    :select nil :align t :size 0.4)
                     ("*Async Shell Command*"     :select nil :align t :size 0.4)
                     ("*Org-Babel Error Output*"  :select nil :align t :size 0.3)
                     ("*package update results*"  :select nil :align t :size 10)
                     ("*Process List*"            :select t   :align t :size 0.3)
                     ("*Occur*"                   :select t   :align t)
                     ("\\*eldoc\\( for \\)?.*\\*" :select nil :align t :size 15 :regexp t))))
#+end_src

** Language
*** Rust
**** Rustic
rustic = basic rust-mode + additions

#+begin_src emacs-lisp
  (use-package rustic
    :ensure
    :bind (:map rustic-mode-map
                ("M-j" . lsp-ui-imenu)
                ("M-?" . lsp-find-references)
                ("C-c C-c l" . flycheck-list-errors)
                ("C-c C-c a" . lsp-execute-code-action)
                ("C-c C-c r" . lsp-rename)
                ("C-c C-c q" . lsp-workspace-restart)
                ("C-c C-c Q" . lsp-workspace-shutdown)
                ("C-c C-c s" . lsp-rust-analyzer-status)
                ("C-c C-c e" . lsp-rust-analyzer-expand-macro)
                ("C-c C-c d" . dap-hydra)
                ("C-c C-c h" . lsp-ui-doc-glance))
    :config (push 'rustic-clippy flycheck-checkers)
            (setq rustic-format-on-save t)
    ;; uncomment for less flashiness
    ;; (setq lsp-eldoc-hook nil)
    ;; (setq lsp-enable-symbol-highlighting nil)
    ;; (setq lsp-signature-auto-activate nil)
    :custom (rustic-lsp-setup-p nil)
            (rustic-analyzer-command '("~/.local/share/cargo/bin/rust-analyzer"))
            (rustic-flycheck-clippy-params "--message-format=json -Zunstable-options")
            (rustic-rustfmt-args "+nightly")
            (rustic-rustfmt-config-alist '((hard_tabs . t) (skip_children . nil)))
    
    (add-hook 'rustic-mode-hook 'kv/rustic-mode-hook))

  (defun kv/rustic-mode-hook ()
    ;; so that run C-c C-c C-r works without having to confirm, but don't try to
    ;; save rust buffers that are not file visiting. Once
    ;; https://github.com/brotzeit/rustic/issues/253 has been resolved this should
    ;; no longer be necessary.
    (when buffer-file-name
      (setq-local buffer-save-without-query t))
    (add-hook 'before-save-hook 'lsp-format-buffer nil t))
#+end_src

**** Rust Playground
Create / cleanup rust scratch projects quickly

#+begin_src emacs-lisp
  (use-package rust-playground :ensure)
#+end_src

**** Toml
Cargo.toml and other config files
#+begin_src emacs-lisp
  (use-package toml-mode :ensure)
#+end_src

*** C/C++

#+begin_src emacs-lisp
#+end_src

*** Yaml

#+begin_src emacs-lisp
  ;; Config files mode
  (use-package yaml-mode
    :ensure t
    :mode ("\\.ya?ml\\'" . yaml-mode))
#+end_src

** Flycheck

#+begin_src emacs-lisp
  (use-package flycheck
    :ensure t
    :hook (prog-mode . flycheck-mode)
    :custom
    (flycheck-temp-prefix ".flycheck")
    (flycheck-check-syntax-automatically '(save mode-enabled))
    (flycheck-emacs-lisp-load-path 'inherit)
    (flycheck-indication-mode 'right-fringe))
#+end_src

*** Flycheck Extensions

#+begin_src emacs-lisp
  ;; inline
  (use-package flycheck-inline)
  (with-eval-after-load 'flycheck
    (add-hook 'flycheck-mode-hook #'flycheck-inline-mode))
  ;; for rust
  (use-package flycheck-rust
    :init
    (add-hook 'flycheck-mode-hook #'flycheck-rust-setup))
#+end_src

** Magit

#+begin_src emacs-lisp
  (use-package magit
    :ensure t
    :hook (git-commit-setup . git-commit-turn-on-flyspell)
    :bind (("C-x g"   . magit-status)
           ("C-x M-g" . magit-dispatch)
           ("C-c M-g" . magit-file-dispatch))
    :custom
    (magit-diff-refine-hunk t)
    (magit-diff-paint-whitespace nil)
    (magit-ediff-dwim-show-on-hunks t))

  ;; NOTE: `diff-hl' depends on `vc'
  (use-package vc
    :ensure nil
    :custom
    (vc-follow-symlinks t)
    (vc-allow-async-revert t)
    (vc-handled-backends '(Git)))

  ;; Highlight uncommitted changes using VC
  (use-package diff-hl
    :ensure t
    :hook ((after-init         . global-diff-hl-mode)
           (dired-mode         . diff-hl-dired-mode-unless-remote)
           (magit-pre-refresh  . diff-hl-magit-pre-refresh)
           (magit-post-refresh . diff-hl-magit-post-refresh))
    :config
    ;; When Emacs runs in terminal, show the indicators in margin instead.
    (unless (display-graphic-p)
      (diff-hl-margin-mode)))

  ;; Visual diff interface
  (use-package ediff
    :ensure nil
    ;; Restore window config after quitting ediff
    :hook ((ediff-before-setup . ediff-save-window-conf)
           (ediff-quit         . ediff-restore-window-conf))
    :config
    (defvar local-ediff-saved-window-conf nil)

    (defun ediff-save-window-conf ()
      (setq local-ediff-saved-window-conf (current-window-configuration)))

    (defun ediff-restore-window-conf ()
      (when (window-configuration-p local-ediff-saved-window-conf)
        (set-window-configuration local-ediff-saved-window-conf)))
    :custom
    (ediff-highlight-all-diffs t)
    (ediff-window-setup-function 'ediff-setup-windows-plain)
    (ediff-split-window-function 'split-window-horizontally)
    (ediff-merge-split-window-function 'split-window-horizontally))

  ;; Setup gitignore mode
  (use-package conf-mode
    :ensure nil
    :mode (("\\.gitignore\\'"     . conf-unix-mode)
           ("\\.gitconfig\\'"     . conf-unix-mode)
           ("\\.gitattributes\\'" . conf-unix-mode)))
#+end_src
